<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fon Cosmetics - Pro Panel</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>



    <style>
        /* --- CSS RESET --- */
        :root {
            --sidebar-width: 260px;
            --header-height: 60px;
            --primary: #3699ff;
            --dark: #1e1e2d;
            --bg: #eef0f8;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
            /* Force font globally */
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #3f4254;
            max-width: 100vw;
            /* Prevent horizontal overflow */
            overflow-x: hidden;
            /* Hide horizontal scrollbar */
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #131313;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .inp-log {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
            font-size: 16px;
        }

        .btn-log {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #ffffff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            height: 100%;
            border-right: 1px solid #eff2f5;
        }

        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            border-bottom: 1px solid #eff2f5;
        }

        .brand img {
            height: 30px;
            object-fit: contain;
        }

        .user-profile {
            padding: 20px;
            border-bottom: 1px solid #eff2f5;
        }

        .u-email {
            color: #181c32;
            font-weight: 600;
            display: block;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .u-role {
            font-size: 10px;
            color: #b5b5c3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
            display: block;
        }

        .menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu li {
            padding: 15px 25px;
            cursor: pointer;
            color: #5e6278;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
            border-left: 3px solid transparent;
        }

        .menu li:hover,
        .menu li.active {
            background: #f5f8fa;
            color: #3699ff;
            border-left-color: var(--primary);
        }

        .admin-only {
            display: none;
        }

        /* --- MAIN --- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            width: 100%;
        }

        .header-bar {
            height: var(--header-height);
            background: #fff;
            border-bottom: 1px solid #e4e6ef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            padding-top: env(safe-area-inset-top);
            /* Safe area for notch */
        }

        .menu-toggle {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
            padding: 15px;
            margin-left: -15px;
        }

        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }

        .view {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        .view.active {
            display: flex;
        }

        /* --- EDITOR --- */
        .editor-container {
            display: flex;
            height: 100%;
            gap: 20px;
        }

        .form-panel {
            width: 360px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.03);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: #f9f9f9;
            min-height: 44px;
            max-height: 44px;
            /* Prevent date inputs from being taller */
            line-height: 1.2;
            /* Normalize line height */
        }

        /* Specific fix for date inputs on mobile */
        input[type="date"].form-control {
            height: 44px !important;
            min-height: 44px !important;
            max-height: 44px !important;
            padding: 10px 12px !important;
            display: block;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Remove default date picker styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.6;
        }

        .form-control:focus {
            background: #fff;
            border-color: var(--primary);
        }

        .grp-label {
            font-size: 11px;
            font-weight: 700;
            color: #181c32;
            margin-top: 5px;
            display: block;
        }

        .btn {
            padding: 14px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            width: 100%;
            min-height: 48px;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-success {
            background: #1bc5bd;
        }

        .btn-danger {
            background: #f64e60;
        }

        .btn-warning {
            background: #ffa800;
        }



        .btn-mobile-pdf {
            background: #8e44ad;
        }

        /* --- PREVIEW PANEL --- */
        .preview-panel {
            flex: 1;
            background: #5e6278;
            border-radius: 8px;
            overflow: auto;
            display: flex;
            justify-content: center;
            padding: 40px;
            position: relative;
        }

        /* EKRANDA GÖRÜNEN SAYFA STİLİ */
        .page {
            width: 210mm;
            height: 297mm;
            min-width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 10mm;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            color: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            transform-origin: top center;
        }

        /* --- INVOICE STYLES --- */
        .inv-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .logo-box img {
            height: 60px;
            object-fit: contain;
        }

        .exporter-info {
            text-align: right;
            font-size: 9px;
            line-height: 1.3;
            color: #000;
        }

        .exporter-info h1 {
            font-size: 14px;
            font-weight: 900;
            margin: 0;
        }

        .inv-title {
            text-align: center;
            font-size: 16px;
            font-weight: 800;
            text-decoration: underline;
            margin: 5px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 70% 29%;
            gap: 1%;
            margin-bottom: 5px;
            font-size: 10px;
        }

        .box {
            border: 1px solid #000;
            padding: 5px;
        }

        .box-title {
            background: #eee;
            font-weight: 700;
            text-align: center;
            border-bottom: 1px solid #000;
            margin: -5px -5px 3px -5px;
            padding: 2px;
        }

        .tbl {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-top: 5px;
        }

        .tbl th {
            background: #eee;
            border: 1px solid #000;
            padding: 4px;
            font-weight: 700;
        }

        .tbl td {
            border: 1px solid #000;
            padding: 3px;
        }

        .footer-wrapper {
            margin-top: auto;
            padding-top: 10px;
            page-break-inside: avoid;
        }

        .ship-box {
            border: 2px solid #000;
            margin-top: 5px;
        }

        .ship-head {
            background: #000;
            color: white;
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            padding: 2px;
        }

        .ship-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            font-size: 8px;
        }

        .scell {
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 2px;
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .scell:nth-child(4n) {
            border-right: none;
        }

        .slbl {
            font-weight: 700;
            color: #555;
            font-size: 9px;
        }

        .sval {
            font-weight: 700;
            color: #000;
            font-size: 10px;
        }

        /* Sidebar List Styles */
        #added-items-list {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .sidebar-item {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            min-height: 56px;
        }

        .sidebar-item-info {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 5px;
        }

        .sidebar-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn-sm {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn-sm.edit {
            color: #3699ff;
            background: #e1f0ff;
        }

        .action-btn-sm.del {
            color: #f64e60;
            background: #ffe2e5;
        }

        .action-btn-sm.move {
            color: #7e8299;
            background: #f5f8fa;
        }

        .action-btn-sm.move:hover {
            background: #e4e6ef;
            color: #3f4254;
        }


        .footer {
            border-top: 2px solid #000;
            padding-top: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            margin-top: 5px;
        }

        /* --- LISTS --- */
        .list-wrapper,
        .user-create-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .invoice-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .invoice-item:active {
            background: #f5f8fa;
        }

        .inv-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .inv-badge {
            background: #e1f0ff;
            color: #3699ff;
            font-weight: 700;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .inv-cust {
            font-weight: 700;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .inv-no {
            font-weight: 600;
            font-size: 12px;
            color: #888;
            background: #f9f9f9;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .inv-btm {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #888;
        }

        /* --- OVERLAY (MENU FIX) --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 900;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        @media (min-width: 901px) {
            .overlay {
                display: none !important;
                pointer-events: none !important;
            }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            .sidebar {
                position: fixed;
                left: -280px;
                height: 100%;
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
            }

            .sidebar.active {
                transform: translateX(280px);
            }

            .menu-toggle {
                display: block;
            }

            .header-bar {
                padding: 0 15px;
                padding-top: max(env(safe-area-inset-top), 20px);
                /* Increased from 10px to 20px */
                margin-top: 0;
                height: auto;
                /* Allow height to adjust with padding */
                min-height: var(--header-height);
            }

            .content-area {
                padding: 10px;
            }

            .editor-container {
                flex-direction: column;
                overflow-y: scroll;
                gap: 0;
            }

            .form-panel {
                width: 100%;
                max-width: 100%;
                /* Prevent overflow */
                box-shadow: none;
                border-bottom: 1px solid #ddd;
                padding: 15px;
                overflow: visible;
                box-sizing: border-box;
                /* Include padding in width */
            }

            .preview-panel {
                min-height: 600px;
                /* Reduced height for better mobile fit */
                padding: 10px;
                background: #5e6278;
                align-items: flex-start;
                overflow: hidden;
                justify-content: center;
                /* Center the scaled page */
            }

            .page {
                transform: scale(0.42);
                /* Slightly smaller scale to ensure fit */
                transform-origin: top center;
                margin-bottom: -150mm;
                /* Adjusted margin for new scale */
            }

            .inv-cust {
                max-width: 120px;
            }
        }

        /* --- PDF ISOLATION MODE (KESİN ÇÖZÜM V2) --- */
        /* PDF modunda diğer her şeyi gizleyen yardımcı sınıf */
        .hide-on-pdf {
            display: none !important;
        }

        body.pdf-capturing {
            background-color: white !important;
            overflow: visible !important;
            /* Scroll'a izin ver ki html2pdf hepsini görsün */
            height: auto !important;
            position: relative !important;
        }

        #pdf-isolation-layer {
            position: absolute;
            /* Fixed yerine Absolute: Sayfa akışında yer alsın */
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            background: white;
            z-index: 9999999;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        /* PDF'e gidecek sayfalar için KATI KURALLAR (Taşmayı önler) */
        .pdf-final-page {
            width: 210mm !important;
            height: 296mm !important;
            /* A4'ten 1mm az: 2. sayfa çıkmasını engeller */
            min-height: 296mm !important;
            max-height: 296mm !important;
            margin: 0 0 0 0 !important;
            padding: 10mm !important;
            background: white !important;
            transform: none !important;
            box-shadow: none !important;
            border: none !important;
            overflow: hidden !important;
            /* Taşan her şeyi keser */
            display: block !important;
            page-break-after: always;
        }

        .pdf-final-page:last-child {
            page-break-after: avoid !important;
            margin-bottom: 0 !important;
        }

        @media print {

            /* Hide non-print elements */
            .hidden-for-print {
                display: none !important;
            }

            /* Remove all margins and set page size */
            @page {
                margin: 0;
                size: A4 portrait;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                width: 210mm;
                height: 297mm;
            }

            body {
                background: white !important;
            }

            /* Each page should be exactly one A4 page */
            .page {
                margin: 0 !important;
                padding: 15mm !important;
                width: 210mm !important;
                height: 297mm !important;
                max-width: 210mm !important;
                box-sizing: border-box !important;
                box-shadow: none !important;
                page-break-after: always !important;
                page-break-inside: avoid !important;
                display: flex !important;
                flex-direction: column !important;
                position: relative !important;
            }

            .page:last-child {
                page-break-after: avoid !important;
            }

            /* Content should take available space */
            .page>div:not(.footer-wrapper) {
                flex: 0 0 auto !important;
            }

            /* Footer at bottom using margin-top auto */
            .footer-wrapper {
                margin-top: auto !important;
                flex-shrink: 0 !important;
                page-break-inside: avoid !important;
            }

            /* Prevent breaks inside critical elements */
            .ship-box,
            .footer,
            table {
                page-break-inside: avoid !important;
            }

            /* Ensure isolation layer is visible and positioned correctly */
            #pdf-isolation-layer {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                visibility: visible !important;
            }

            /* Ensure content inside isolation layer is visible */
            #pdf-isolation-layer * {
                visibility: visible !important;
            }

            /* Force layout preservation */
            #pdf-isolation-layer .inv-header,
            #pdf-isolation-layer .footer,
            #pdf-isolation-layer .inv-top,
            #pdf-isolation-layer .inv-btm {
                display: flex !important;
            }

            #pdf-isolation-layer .info-grid,
            #pdf-isolation-layer .ship-grid {
                display: grid !important;
            }

            .pdf-final-page {
                margin: 0 !important;
                page-break-after: always !important;
                box-shadow: none !important;
                width: 100% !important;
                height: 297mm !important;
                overflow: hidden !important;
                background: white !important;
            }

            .pdf-final-page:last-child {
                page-break-after: avoid !important;
            }
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
        }

        .action-btn.edit {
            color: #3699ff;
        }

        .action-btn.delete {
            color: #f64e60;
        }
    </style>
</head>

<body>

    <datalist id="dl-customers"></datalist>
    <datalist id="dl-products"></datalist>
    <datalist id="dl-users"></datalist>

    <div id="login-screen">
        <div class="login-card">
            <div style="background:white; padding:10px; border-radius:5px; display:inline-block; margin-bottom:20px;">
                <img src="fonlogo.png" style="height: 50px;" alt="FON LOGO"
                    onerror="this.src='https://via.placeholder.com/150x50?text=LOGO+YOK'">
            </div>
            <h2 style="font-weight:800; letter-spacing:-1px; color:#1e1e2d; margin-top:0;">FON ADMIN</h2>
            <form id="login-form" onsubmit="doLogin(); return false;" autocomplete="on">
                <input type="email" id="log-email" name="email" class="inp-log" placeholder="E-posta"
                    autocomplete="email" required>
                <input type="password" id="log-pass" name="password" class="inp-log" placeholder="Şifre"
                    autocomplete="current-password" required>
                <div style="display:flex; align-items:center; margin-bottom:15px; justify-content:flex-start;">
                    <input type="checkbox" id="remember-me" name="remember" style="width:auto; margin-right:8px;">
                    <label for="remember-me" style="font-size:14px; color:#555; cursor:pointer;">Beni Hatırla</label>
                </div>
                <button type="submit" class="btn-log">Giriş Yap</button>
            </form>
            <p id="log-msg" style="color:#f64e60; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="brand">
            <img src="fonlogo.png" alt="FON LOGO" onerror="this.src='https://via.placeholder.com/150x50?text=LOGO+YOK'">
        </div>
        <div class="user-profile">
            <span class="u-email" id="u-email">...</span>
            <span class="u-role" id="u-role">Kullanıcı</span>
        </div>
        <ul class="menu">
            <li onclick="switchView('editor', this)" class="active"><i class="fas fa-file-invoice"></i> Fatura Oluştur
            </li>
            <li onclick="switchView('list', this)"><i class="fas fa-list"></i> Fatura Listesi</li>
            <li onclick="switchView('users', this)" class="admin-only"><i class="fas fa-user-plus"></i> Kullanıcı Ekle
            </li>
            <li onclick="doLogout()" style="margin-top:auto; color:#f64e60;"><i class="fas fa-power-off"></i> Çıkış Yap
            </li>
        </ul>
    </div>

    <div class="main">
        <div class="header-bar">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars menu-toggle" onclick="toggleSidebar()"></i>
                <div style="margin-left:10px;">
                    <div style="font-weight:700; font-size:16px;">Fatura Paneli</div>
                    <div style="font-size:11px; color:#aaa;">v20.0 Final</div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div id="view-editor" class="view active">
                <div class="editor-container">
                    <div class="form-panel">
                        <div id="admin-owner-wrapper"
                            style="display:none; background:#ffe2e5; padding:10px; border-radius:6px; margin-bottom:10px; border:1px solid #f64e60;">
                            <span class="grp-label" style="color:#f64e60; margin-top:0;">YÖNETİCİ: FATURA SAHİBİ</span>
                            <input id="i-owner" class="form-control" list="dl-users" placeholder="kullanici@mail.com">
                        </div>
                        <button class="btn btn-warning" onclick="resetForm()">TEMİZLE / YENİ</button>

                        <span class="grp-label">FATURA TİPİ & PARA BİRİMİ</span>
                        <select id="i-type" class="form-control" onchange="upd()">
                            <option>PROFORMA INVOICE</option>
                            <option>COMMERCIAL INVOICE</option>
                        </select>
                        <div style="display:flex; gap:8px;">
                            <select id="i-currency" class="form-control" onchange="renderPages()">
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (€)</option>
                                <option value="TL">TL (₺)</option>
                                <option value="RUB">RUB (₽)</option>
                            </select>
                            <input id="i-contr" class="form-control" placeholder="Sözleşme No" oninput="upd()">
                        </div>

                        <div style="background:#f0f2f5; padding:10px; border-radius:6px; border:1px solid #e4e6ef;">
                            <span class="grp-label" style="margin-top:0;">MÜŞTERİ (OTO TAMAMLAMA)</span>
                            <input id="i-imp" class="form-control" placeholder="Firma Adı Ara..." oninput="upd()"
                                list="dl-customers" style="margin-bottom:5px;">
                            <textarea id="i-addr" class="form-control" rows="2" placeholder="Adres" oninput="upd()"
                                style="margin-bottom:5px;"></textarea>
                            <input id="i-tel" class="form-control" placeholder="Telefon" oninput="upd()">
                        </div>

                        <div style="display:flex; gap:8px;">
                            <div style="flex:1"><span class="grp-label">FATURA NO</span><input id="i-no"
                                    class="form-control" oninput="upd()"></div>
                            <div style="flex:1"><span class="grp-label">TARİH</span><input type="date" id="i-date"
                                    class="form-control" oninput="upd()"></div>
                        </div>

                        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                        <span class="grp-label">ÜRÜN EKLE (OTO TAMAMLAMA)</span>
                        <input id="p-name" class="form-control" placeholder="Ürün Adı Ara..." list="dl-products">
                        <div style="display:flex; gap:8px; margin-top:5px;">
                            <input id="p-code" class="form-control" placeholder="Kod" style="flex:1">
                            <input id="p-qty" type="number" class="form-control" placeholder="Adet" style="width:70px;">
                            <input id="p-price" type="number" class="form-control" placeholder="Fiyat" step="0.01"
                                style="width:80px;">
                        </div>
                        <button class="btn btn-primary" style="margin-top:8px;" onclick="addItem()">+ LİSTEYE
                            EKLE</button>

                        <div id="added-items-list"></div>

                        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                        <span class="grp-label">LOJİSTİK BİLGİLERİ</span>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                            <input id="i-load" class="form-control" placeholder="Loading" oninput="upd()">
                            <input id="i-trans" class="form-control" placeholder="Transport" oninput="upd()">
                            <input id="i-pay" class="form-control" placeholder="Payment" oninput="upd()">
                            <input id="i-del" class="form-control" placeholder="Delivery" oninput="upd()">
                        </div>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <input id="i-box" class="form-control" placeholder="Koli" oninput="upd()">
                            <input id="i-nw" class="form-control" placeholder="Net KG" oninput="upd()">
                            <input id="i-gw" class="form-control" placeholder="Brüt KG" oninput="upd()">
                        </div>

                        <div style="margin-top:8px;">
                            <span class="grp-label">G.T.I.P KODLARI</span>
                            <textarea id="i-gtip" class="form-control" rows="2" placeholder="Örn: 3303.00.90.00.11"
                                oninput="upd()"></textarea>
                        </div>

                        <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                        <button class="btn btn-success" onclick="saveInvoice()">KAYDET (CLOUD)</button>

                        <div style="margin-top:10px;">
                            <button class="btn btn-primary" style="background:#181c32;"
                                onclick="handleExport('print')">YAZDIR / PDF</button>
                        </div>
                        <button class="btn btn-success" style="margin-top:5px; background:#217346;"
                            onclick="exportToExcel()">EXCEL İNDİR</button>

                        <button class="btn btn-danger" style="margin-top:10px; display:none;" id="btn-del"
                            onclick="deleteInvoice()">SİL</button>
                    </div>

                    <div class="preview-panel" id="print-area"></div>
                </div>
            </div>

            <div id="view-list" class="view">
                <div class="list-wrapper">
                    <h3 style="margin-top:0;">Kayıtlı Faturalar</h3>
                    <div id="invoice-list-area">Yükleniyor...</div>
                </div>
            </div>

            <div id="view-users" class="view">
                <div class="user-create-card">
                    <h3>Kullanıcı Ekle</h3>
                    <p style="font-size:13px; color:#666;">Yeni kullanıcı oluşturun. Kullanıcı sadece kendi kayıtlarını
                        görebilir.</p>
                    <input id="new-email" class="form-control" placeholder="E-posta" style="margin-bottom:10px;">
                    <input id="new-pass" class="form-control" placeholder="Şifre" type="password"
                        style="margin-bottom:15px;">
                    <button class="btn btn-success" onclick="createUser()">OLUŞTUR</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const SUPER_ADMIN_EMAIL = "turker@taximact.com";

        const firebaseConfig = {
            apiKey: "AIzaSyCNLiF-01FfNkEbEUsOg4FkJRIuNL3mSfw",
            authDomain: "foninvoicer.firebaseapp.com",
            projectId: "foninvoicer",
            storageBucket: "foninvoicer.firebasestorage.app",
            messagingSenderId: "677195931586",
            appId: "1:677195931586:web:d6dce9c8ac8be34ff1805b"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");

        let items = [];
        let currentId = null;
        let customerDB = {};
        let productDB = {};
        let userSet = new Set();

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('u-email').innerText = user.email;
                if (user.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('u-role').innerText = "YÖNETİCİ";
                    document.getElementById('u-role').classList.add('admin');
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                    document.getElementById('admin-owner-wrapper').style.display = 'block';
                } else {
                    document.getElementById('u-role').innerText = "Kullanıcı";
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    document.getElementById('admin-owner-wrapper').style.display = 'none';
                }
                getInvoices();
                renderPages();
                setupAutocomplete();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function doLogin() {
            const e = document.getElementById('log-email').value;
            const p = document.getElementById('log-pass').value;
            const remember = document.getElementById('remember-me').checked;

            if (remember) {
                localStorage.setItem('savedEmail', e);
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => auth.signInWithEmailAndPassword(e, p))
                    .catch(err => document.getElementById('log-msg').innerText = err.message);
            } else {
                localStorage.removeItem('savedEmail');
                auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
                    .then(() => auth.signInWithEmailAndPassword(e, p))
                    .catch(err => document.getElementById('log-msg').innerText = err.message);
            }
        }

        // Pre-fill email if saved
        window.addEventListener('load', () => {
            const savedEmail = localStorage.getItem('savedEmail');
            if (savedEmail) {
                document.getElementById('log-email').value = savedEmail;
                document.getElementById('remember-me').checked = true;
            }
        });

        function doLogout() { auth.signOut(); location.reload(); }
        function createUser() {
            const e = document.getElementById('new-email').value;
            const p = document.getElementById('new-pass').value;
            if (!e || !p) return alert("Bilgileri doldurun");
            secondaryApp.auth().createUserWithEmailAndPassword(e, p).then(() => {
                alert("Kullanıcı oluşturuldu!");
                document.getElementById('new-email').value = "";
                document.getElementById('new-pass').value = "";
                secondaryApp.auth().signOut();
            }).catch(err => alert(err.message));
        }

        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if (el) {
                document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
                el.classList.add('active');
            }

            if (window.innerWidth <= 900) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.overlay').classList.remove('active');
            }
        }

        function upd() { renderPages(); }

        function setupAutocomplete() {
            document.getElementById('i-imp').addEventListener('input', function () {
                const val = this.value;
                if (customerDB[val]) {
                    document.getElementById('i-addr').value = customerDB[val].addr || '';
                    document.getElementById('i-tel').value = customerDB[val].tel || '';
                    upd();
                }
            });
            document.getElementById('p-name').addEventListener('input', function () {
                const val = this.value;
                if (productDB[val]) {
                    document.getElementById('p-code').value = productDB[val].code || '';
                    document.getElementById('p-price').value = productDB[val].price || '';
                    document.getElementById('p-qty').value = 1;
                }
            });
        }

        function updateDatalists() {
            const dlCust = document.getElementById('dl-customers'); dlCust.innerHTML = '';
            Object.keys(customerDB).forEach(n => { const o = document.createElement('option'); o.value = n; dlCust.appendChild(o); });
            const dlProd = document.getElementById('dl-products'); dlProd.innerHTML = '';
            Object.keys(productDB).forEach(n => { const o = document.createElement('option'); o.value = n; dlProd.appendChild(o); });
            const dlUsers = document.getElementById('dl-users'); dlUsers.innerHTML = '';
            userSet.forEach(u => { const o = document.createElement('option'); o.value = u; dlUsers.appendChild(o); });
        }

        function addItem() {
            const name = document.getElementById('p-name').value;
            const code = document.getElementById('p-code').value;
            const qty = Number(document.getElementById('p-qty').value);
            const price = Number(document.getElementById('p-price').value);
            if (!name) return alert("Ürün adı giriniz");
            items.push({ name, code, qty, price });
            renderPages();
            document.getElementById('p-name').value = '';
            document.getElementById('p-code').value = '';
            document.getElementById('p-qty').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-name').focus();
        }
        function delItem(i) { items.splice(i, 1); renderPages(); }

        function editItem(i) {
            const item = items[i];
            document.getElementById('p-name').value = item.name;
            document.getElementById('p-code').value = item.code;
            document.getElementById('p-qty').value = item.qty;
            document.getElementById('p-price').value = item.price;
            items.splice(i, 1);
            renderPages();
        }

        function moveItem(i, direction) {
            if (direction === -1 && i === 0) return; // Can't move up
            if (direction === 1 && i === items.length - 1) return; // Can't move down

            const temp = items[i];
            items[i] = items[i + direction];
            items[i + direction] = temp;
            renderPages();
        }

        function renderSidebarItems() {
            const list = document.getElementById('added-items-list');
            list.innerHTML = '';
            items.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'sidebar-item';

                let moveButtons = '';
                if (items.length > 1) {
                    moveButtons = `
                        <div class="action-btn-sm move" onclick="moveItem(${i}, -1)" style="${i === 0 ? 'visibility:hidden' : ''}"><i class="fas fa-arrow-up"></i></div>
                        <div class="action-btn-sm move" onclick="moveItem(${i}, 1)" style="${i === items.length - 1 ? 'visibility:hidden' : ''}"><i class="fas fa-arrow-down"></i></div>
                    `;
                }

                div.innerHTML = `
                    <div class="sidebar-item-info">
                        <strong>${i + 1}.</strong> ${item.name} (${item.qty})
                    </div>
                    <div class="sidebar-actions">
                        ${moveButtons}
                        <div class="action-btn-sm edit" onclick="editItem(${i})"><i class="fas fa-edit"></i></div>
                        <div class="action-btn-sm del" onclick="delItem(${i})"><i class="fas fa-trash"></i></div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderPages() {
            renderSidebarItems(); // Update sidebar list

            const container = document.getElementById('print-area');
            container.innerHTML = '';

            const d = {
                type: document.getElementById('i-type').value,
                imp: document.getElementById('i-imp').value,
                addr: document.getElementById('i-addr').value,
                tel: document.getElementById('i-tel').value,
                no: document.getElementById('i-no').value,
                date: document.getElementById('i-date').value,
                contr: document.getElementById('i-contr').value,
                load: document.getElementById('i-load').value,
                trans: document.getElementById('i-trans').value,
                pay: document.getElementById('i-pay').value,
                del: document.getElementById('i-del').value,
                box: document.getElementById('i-box').value,
                nw: document.getElementById('i-nw').value,
                gw: document.getElementById('i-gw').value,
                cur: document.getElementById('i-currency').value,
                gtip: document.getElementById('i-gtip').value
            };

            const curSym = d.cur === 'USD' ? '$' : (d.cur === 'EUR' ? '€' : (d.cur === 'TL' ? '₺' : '₽'));
            let iban = "TR81 0001 5001 5804 8020 9710 65";
            if (d.cur === 'EUR') iban = "TR49 0001 5001 5804 8020 9710 59";
            if (d.cur === 'TL') iban = "TR04 0001 5001 5800 7315 1460 36";

            const headerHTML = `
                <div class="inv-header">
                    <div class="logo-box">
                        <img src="fonlogo.png" onerror="this.src='https://via.placeholder.com/150x50?text=LOGO+YOK'">
                    </div>
                    <div class="exporter-info">
                        <h1>FON KOZMETİK SAN. VE TİC. LTD. ŞTİ.</h1>
                        <p>Ortaköy Merkez Mah. Yeldeğirmeni Cad. No:17/A<br>Silivri / İSTANBUL - TURKEY</p>
                        <p>Tel: +90 212 734 38 20 | info@fonkozmetik.com<br>
                        Silivri V.D. - 3880040480</p>
                    </div>
                </div>
                <div class="inv-title">${d.type}</div>
                <div class="info-grid">
                    <div class="box">
                        <div class="box-title">IMPORTER (ALICI)</div>
                        <strong style="display:block;margin-bottom:2px;font-size:10px;">${d.imp || '-'}</strong>
                        <span style="white-space:pre-line;display:block;margin-bottom:2px;">${d.addr || '-'}</span>
                        <span>${d.tel || '-'}</span>
                    </div>
                    <div class="box" style="padding:0;border:none;">
                        <table style="width:100%;font-size:9px;border-collapse:collapse;">
                            <tr><td style="border:1px solid #000;padding:2px;font-weight:700;background:#eee;">NO</td><td style="border:1px solid #000;padding:2px;">${d.no || '-'}</td></tr>
                            <tr><td style="border:1px solid #000;padding:2px;font-weight:700;background:#eee;">DATE</td><td style="border:1px solid #000;padding:2px;">${formatDateDDMMYYYY(d.date)}</td></tr>
                            <tr><td style="border:1px solid #000;padding:2px;font-weight:700;background:#eee;">CONT.</td><td style="border:1px solid #000;padding:2px;">${d.contr || '-'}</td></tr>
                        </table>
                    </div>
                </div>
                <table class="tbl">
                    <thead><tr><th style="width:5%">No</th><th style="width:45%">Description</th><th style="width:15%">Code</th><th style="width:10%">Qty</th><th style="width:10%">Price</th><th style="width:15%">Total</th></tr></thead>
                    <tbody>
            `;

            const getFooterHTML = (gTot, tUnit) => `
                    </tbody></table></div>
                    <div class="footer-wrapper">
                        <div class="ship-box">
                            <div class="ship-head">SHIPPING & LOGISTIC DETAILS</div>
                            <div class="ship-grid">
                                <div class="scell"><span class="slbl">Loading</span><span class="sval">${d.load || '-'}</span></div>
                                <div class="scell"><span class="slbl">Transport</span><span class="sval">${d.trans || '-'}</span></div>
                                <div class="scell"><span class="slbl">Payment</span><span class="sval">${d.pay || '-'}</span></div>
                                <div class="scell"><span class="slbl">Delivery</span><span class="sval">${d.del || '-'}</span></div>
                                <div class="scell" style="border-bottom:none;"><span class="slbl">Boxes</span><span class="sval">${d.box || '-'}</span></div>
                                <div class="scell" style="border-bottom:none;"><span class="slbl">Net KG</span><span class="sval">${d.nw || '-'}</span></div>
                                <div class="scell" style="border-bottom:none;"><span class="slbl">Gross KG</span><span class="sval">${d.gw || '-'}</span></div>
                                <div class="scell" style="border-bottom:none;"><span class="slbl">Total QTY</span><span class="sval">${tUnit} PCS</span></div>
                            </div>
                        </div>
                        <div class="footer">
                            <div>
                                <strong>MANUFACTURER:</strong> FON KOZMETIK SAN. VE TIC. LTD. STI.<br>
                                ${d.gtip ? `<strong>G.T.I.P:</strong> ${d.gtip}<br>` : ''}
                                GOODS ARE OF TURKISH ORIGIN.
                            </div>
                            <div style="border:1px solid #999;padding:3px;width:45%;"><strong>BANK: VAKIFBANK (${d.cur})</strong><br>BENEFICIARY: FON KOZMETİK SAN.VE TİC.LTD.ŞTİ.<br>IBAN: ${iban} <br> SWIFT: TVBATR2A</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px;text-align:center;font-size:9px;">
                            <div></div>
                            <div>
                                <strong>FON KOZMETIK SAN. VE TIC. LTD. STI.</strong><br>
                                <img src="sign.png" style="height:150px; margin-top:5px; object-fit:contain;" alt="Signature">
                            </div>
                        </div>
                    </div>
            `;

            let currentPage = document.createElement('div'); currentPage.className = 'page';
            container.appendChild(currentPage);
            let pageContent = headerHTML;
            let rowsHTML = '';
            let itemCount = 0, grandTotal = 0, totalUnits = 0;
            const LIMIT_FIRST = 20; // Fits with 150px signature without overflow
            const LIMIT_OTHER = 24;
            let currentLimit = LIMIT_FIRST;
            let pageIndex = 1;

            items.forEach((item, index) => {
                let t = item.qty * item.price;
                grandTotal += t; totalUnits += item.qty;
                rowsHTML += `<tr>
                    <td style="text-align:center">${index + 1}</td>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.code}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:center">${curSym}${item.price.toFixed(2)}</td>
                    <td style="text-align:right">${curSym}${t.toFixed(2)}</td>
                </tr>`;
                itemCount++;
                if (itemCount >= currentLimit && index < items.length - 1) {
                    let pageNumHtml = (items.length > LIMIT_FIRST) ? `<div class="page-num">Page ${pageIndex} / ${Math.ceil(items.length / LIMIT_OTHER)}</div>` : '';
                    currentPage.innerHTML = pageContent.replace(`<div class="inv-title">${d.type}</div>`, `<div class="inv-title">${d.type}</div>${pageNumHtml}`) + rowsHTML + `</tbody></table></div>`;
                    currentPage = document.createElement('div'); currentPage.className = 'page';
                    container.appendChild(currentPage);
                    pageIndex++;
                    pageContent = headerHTML;
                    rowsHTML = ''; itemCount = 0; currentLimit = LIMIT_OTHER;
                }
            });

            // Add Grand Total and Amount in Words
            let currencyName = d.cur;
            let minorUnit = 'Cents';
            if (d.cur === 'TL') { currencyName = 'Turkish Liras'; minorUnit = 'Kurus'; }
            if (d.cur === 'EUR') { currencyName = 'Euros'; }
            if (d.cur === 'RUB') { currencyName = 'Rubles'; minorUnit = 'Kopeks'; }
            if (d.cur === 'USD') { currencyName = 'Dollars'; }

            let wholePart = Math.floor(grandTotal);
            let decimalPart = Math.round((grandTotal - wholePart) * 100);
            let textTotal = `${numberToEnglishWords(wholePart)} ${currencyName}`;
            if (decimalPart > 0) {
                textTotal += ` and ${numberToEnglishWords(decimalPart)} ${minorUnit}`;
            } else {
                textTotal += ` Only`;
            }

            rowsHTML += `
                <tr>
                    <td colspan="5" style="text-align:right; font-weight:bold; border:none;">GRAND TOTAL</td>
                    <td style="text-align:right; font-weight:bold; border:1px solid #000;">${curSym}${grandTotal.toFixed(2)}</td>
                </tr>
                <tr>
                    <td colspan="6" style="text-align:center; font-weight:bold; border:none; padding:5px; font-style:italic; background:#f9f9f9;">
                        "${textTotal}"
                    </td>
                </tr>
            `;

            let pageNumHtml = (items.length > LIMIT_FIRST) ? `<div class="page-num">Page ${pageIndex} / ${Math.ceil(items.length / LIMIT_OTHER)}</div>` : '';
            currentPage.innerHTML = pageContent.replace(`<div class="inv-title">${d.type}</div>`, `<div class="inv-title">${d.type}</div>${pageNumHtml}`) + rowsHTML + getFooterHTML(grandTotal, totalUnits);
        }



        let logoBase64 = '';
        let signBase64 = '';

        // Convert images to base64 on page load
        // Convert images to base64 on page load (with resizing for performance)
        function convertImagesToBase64() {
            const MAX_WIDTH = 500; // Limit width to 500px for faster processing

            const processImage = (src, callback) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function () {
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/png', 0.8)); // Use 0.8 quality
                };
                img.onerror = function () {
                    console.error("Image load failed:", src);
                    callback(''); // Return empty string on error
                };
                img.src = src;
            };

            processImage('fonlogo.png', (base64) => { logoBase64 = base64; });
            processImage('sign.png', (base64) => { signBase64 = base64; });
        }

        // --- EXPORT FUNCTION (PRINT & PDF) ---
        function handleExport(mode) {
            const pages = document.querySelectorAll('.page');
            if (pages.length === 0) return alert("Önce fatura oluşturmalısınız.");

            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'export-loading';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '0';
            loadingDiv.style.left = '0';
            loadingDiv.style.width = '100%';
            loadingDiv.style.height = '100%';
            loadingDiv.style.background = 'rgba(0,0,0,0.8)';
            loadingDiv.style.color = 'white';
            loadingDiv.style.zIndex = '10000000';
            loadingDiv.style.display = 'flex';
            loadingDiv.style.alignItems = 'center';
            loadingDiv.style.justifyContent = 'center';
            loadingDiv.style.fontSize = '24px';
            loadingDiv.style.fontWeight = 'bold';
            loadingDiv.innerHTML = '<div>İşlem Yapılıyor...<br><span style="font-size:14px; font-weight:normal">Lütfen bekleyiniz.</span></div>';
            document.body.appendChild(loadingDiv);

            const originalScrollPos = window.scrollY;

            // Create isolated container
            const container = document.createElement('div');
            container.id = 'pdf-isolation-layer';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '210mm';
            container.style.background = 'white';
            container.style.zIndex = '9999999';

            // Clone pages and replace logo with base64
            pages.forEach((page) => {
                const clone = page.cloneNode(true);
                clone.classList.remove('page');
                clone.classList.add('pdf-final-page');

                // Replace all logo images with base64
                const imgs = clone.querySelectorAll('img');
                imgs.forEach(img => {
                    if (img.src.includes('fonlogo.png') && logoBase64) {
                        img.src = logoBase64;
                    }
                    if (img.src.includes('sign.png')) {
                        if (signBase64) {
                            img.src = signBase64;
                        }
                        img.style.maxWidth = '200px'; // Limit width
                        img.style.height = '150px';   // Match preview size exactly
                        img.style.objectFit = 'contain';
                    }
                });

                container.appendChild(clone);
            });

            // Hide everything else explicitly
            document.body.appendChild(container);
            document.body.classList.add('pdf-capturing');

            // Hide all direct children of body except scripts, styles, and our container
            const children = document.body.children;
            for (let i = 0; i < children.length; i++) {
                const child = children[i];
                if (child !== container && child.tagName !== 'SCRIPT' && child.tagName !== 'STYLE') {
                    child.classList.add('hidden-for-print');
                }
            }

            window.scrollTo(0, 0);

            // Wait for images/layout (reduced from 500ms for faster print)
            setTimeout(() => {
                // Setup cleanup listener before printing
                const cleanupListener = () => {
                    cleanup();
                    window.removeEventListener('afterprint', cleanupListener);
                };
                window.addEventListener('afterprint', cleanupListener);

                window.print();

                // Fallback cleanup
                setTimeout(() => {
                    if (document.body.contains(container)) {
                        // Optional: Auto cleanup if afterprint fails?
                        // For now, we rely on afterprint or user refresh if stuck.
                    }
                }, 2000);
            }, 50); // Reduced from 100ms to 50ms

            function cleanup() {
                if (document.getElementById('export-loading')) {
                    document.body.removeChild(document.getElementById('export-loading'));
                }
                if (document.body.contains(container)) {
                    document.body.removeChild(container);
                }
                document.body.classList.remove('pdf-capturing');

                const hidden = document.querySelectorAll('.hidden-for-print');
                hidden.forEach(el => el.classList.remove('hidden-for-print'));

                // Also remove the old class just in case
                const oldHidden = document.querySelectorAll('.hide-on-pdf');
                oldHidden.forEach(el => el.classList.remove('hide-on-pdf'));

                window.scrollTo(0, originalScrollPos);
            }
        }

        // --- EXCEL EXPORT ---
        function exportToExcel() {
            try {
                const d = {
                    type: document.getElementById('i-type').value,
                    imp: document.getElementById('i-imp').value,
                    addr: document.getElementById('i-addr').value,
                    tel: document.getElementById('i-tel').value,
                    no: document.getElementById('i-no').value,
                    date: formatDateDDMMYYYY(document.getElementById('i-date').value),
                    contr: document.getElementById('i-contr').value,
                    load: document.getElementById('i-load').value,
                    trans: document.getElementById('i-trans').value,
                    pay: document.getElementById('i-pay').value,
                    del: document.getElementById('i-del').value,
                    box: document.getElementById('i-box').value,
                    nw: document.getElementById('i-nw').value,
                    gw: document.getElementById('i-gw').value,
                    cur: document.getElementById('i-currency').value,
                    gtip: document.getElementById('i-gtip').value
                };

                let rows = '';
                let grandTotal = 0;
                let totalUnits = 0;

                items.forEach((item, i) => {
                    let t = item.qty * item.price;
                    grandTotal += t;
                    totalUnits += item.qty;
                    rows += `
                        <tr>
                            <td style="border:1px solid #000; text-align:center;">${i + 1}</td>
                            <td style="border:1px solid #000; text-align:left;">${item.name}</td>
                            <td style="border:1px solid #000; text-align:center;">${item.code}</td>
                            <td style="border:1px solid #000; text-align:center;">${item.qty}</td>
                            <td style="border:1px solid #000; text-align:right;">${curSym} ${item.price.toFixed(2)}</td>
                            <td style="border:1px solid #000; text-align:right;">${curSym} ${t.toFixed(2)}</td>
                        </tr>
                    `;
                });

                // Amount in words
                let currencyName = d.cur;
                let minorUnit = 'Cents';
                if (d.cur === 'TL') { currencyName = 'Turkish Liras'; minorUnit = 'Kurus'; }
                if (d.cur === 'EUR') { currencyName = 'Euros'; }
                if (d.cur === 'RUB') { currencyName = 'Rubles'; minorUnit = 'Kopeks'; }
                if (d.cur === 'USD') { currencyName = 'Dollars'; }

                const curSym = d.cur === 'USD' ? '$' : (d.cur === 'EUR' ? '€' : (d.cur === 'TL' ? '₺' : '₽'));

                let wholePart = Math.floor(grandTotal);
                let decimalPart = Math.round((grandTotal - wholePart) * 100);
                let textTotal = `${numberToEnglishWords(wholePart)} ${currencyName}`;
                if (decimalPart > 0) textTotal += ` and ${numberToEnglishWords(decimalPart)} ${minorUnit}`;
                else textTotal += ` Only`;

                const excelHTML = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <!--[if gte mso 9]>
                        <xml>
                            <x:ExcelWorkbook>
                                <x:ExcelWorksheets>
                                    <x:ExcelWorksheet>
                                        <x:Name>Invoice</x:Name>
                                        <x:WorksheetOptions>
                                            <x:DisplayGridlines/>
                                        </x:WorksheetOptions>
                                    </x:ExcelWorksheet>
                                </x:ExcelWorksheets>
                            </x:ExcelWorkbook>
                        </xml>
                        <![endif]-->
                        <meta charset="UTF-8">
                        <style>
                            table { border-collapse: collapse; }
                            td { font-family: 'Calibri', sans-serif; font-size: 11pt; padding: 5px; }
                            .border { border: 1px solid #000; }
                            .bold { font-weight: bold; }
                            .center { text-align: center; }
                            .left { text-align: left; }
                            .right { text-align: right; }
                        </style>
                    </head>
                    <body>
                        <table>
                            <!-- LOGO & HEADER -->
                            <tr>
                                <td colspan="2" rowspan="4" style="text-align:center; vertical-align:middle; font-size:22pt; font-weight:bold; color:black;">
                                    FON COSMETICS
                                </td>
                                <td colspan="4" style="text-align:right; font-size:10pt;">
                                    <b>FON KOZMETİK SAN. VE TİC. LTD. ŞTİ.</b><br>
                                    Ortaköy Merkez Mah. Yeldeğirmeni Cad. No:17/A<br>
                                    Silivri / İSTANBUL - TURKEY<br><br>
                                    Tel: +90 212 734 38 20 | info@fonkozmetik.com
                                </td>
                            </tr>
                            <tr></tr><tr></tr><tr></tr>
                            
                            <tr><td colspan="6" style="height:10px;"></td></tr>

                            <!-- TITLE -->
                            <tr>
                                <td colspan="6" style="text-align:center; font-size:16pt; font-weight:bold;">${d.type}</td>
                            </tr>

                            <!-- CUSTOMER & INVOICE INFO -->
                            <tr>
                                <td colspan="3" rowspan="3" style="vertical-align:top;">
                                    <b>${d.imp}</b><br>
                                    ${d.addr}<br>
                                    ${d.tel}
                                </td>
                                <td class="border bold">Invoice No:</td>
                                <td colspan="2" class="border right">${d.no}</td>
                            </tr>
                            <tr>
                                <td class="border bold">Date:</td>
                                <td colspan="2" class="border right">${d.date}</td>
                            </tr>
                            <tr>
                                <td class="border bold">Contact:</td>
                                <td colspan="2" class="border right">${d.contr}</td>
                            </tr>

                            <tr><td colspan="6" style="height:10px;"></td></tr>

                            <!-- TABLE HEADER -->
                            <tr style="font-weight:bold; text-align:center;">
                                <td style="border:1px solid #000; text-align:center; width:50px;">No</td>
                                <td style="border:1px solid #000; text-align:center; width:400px;">Description</td>
                                <td style="border:1px solid #000; text-align:center; width:120px;">Code</td>
                                <td style="border:1px solid #000; text-align:center; width:80px;">Qty</td>
                                <td style="border:1px solid #000; text-align:center; width:100px;">Prices</td>
                                <td style="border:1px solid #000; text-align:center; width:120px;">Total</td>
                            </tr>

                            <!-- ITEMS -->
                            ${rows}

                            <!-- TOTAL -->
                            <tr>
                                <td colspan="5" style="border:1px solid #000; text-align:right; font-weight:bold;">TOTAL ${d.cur}:</td>
                                <td style="border:1px solid #000; text-align:right; font-weight:bold;">${curSym} ${grandTotal.toFixed(2)}</td>
                            </tr>
                            
                            <!-- AMOUNT IN WORDS -->
                            <tr>
                                <td colspan="6" style="border:1px solid #000; text-align:center;">"${textTotal}"</td>
                            </tr>

                            <tr><td colspan="6" style="height:10px;"></td></tr>

                            <!-- SHIPPING HEADER -->
                            <tr>
                                <td colspan="6" style="background-color:black; color:white; font-weight:bold; text-align:center; padding:8px;">SHIPPING & LOGISTIC DETAILS</td>
                            </tr>
                            
                            <!-- SHIPPING LABELS ROW 1 -->
                            <tr style="text-align:center;">
                                <td colspan="2" style="border:1px solid #000; text-align:center;">Loading:</td>
                                <td colspan="2" style="border:1px solid #000; text-align:center;">Transport:</td>
                                <td style="border:1px solid #000; text-align:center;">Payment Conditions:</td>
                                <td style="border:1px solid #000; text-align:center;">Delivery:</td>
                            </tr>
                            
                            <!-- SHIPPING VALUES ROW 1 -->
                            <tr style="text-align:center; font-weight:bold; text-transform:uppercase;">
                                <td colspan="2" style="border:1px solid #000; text-align:center;">${d.load}</td>
                                <td colspan="2" style="border:1px solid #000; text-align:center;">${d.trans}</td>
                                <td style="border:1px solid #000; text-align:center;">${d.pay}</td>
                                <td style="border:1px solid #000; text-align:center;">${d.del}</td>
                            </tr>
                            
                            <!-- SHIPPING LABELS ROW 2 -->
                            <tr style="text-align:center;">
                                <td colspan="2" style="border:1px solid #000; text-align:center;">Boxes:</td>
                                <td colspan="2" style="border:1px solid #000; text-align:center;">Net KG:</td>
                                <td style="border:1px solid #000; text-align:center;">Gross KG:</td>
                                <td style="border:1px solid #000; text-align:center;">Total QTY:</td>
                            </tr>
                            
                            <!-- SHIPPING VALUES ROW 2 -->
                            <tr style="text-align:center; font-weight:bold;">
                                <td colspan="2" style="border:1px solid #000; text-align:center;">${d.box}</td>
                                <td colspan="2" style="border:1px solid #000; text-align:center;">${d.nw}</td>
                                <td style="border:1px solid #000; text-align:center;">${d.gw}</td>
                                <td style="border:1px solid #000; text-align:center;">${totalUnits} PCS</td>
                            </tr>

                            <tr><td colspan="6" style="height:15px;"></td></tr>

                            <!-- FOOTER -->
                            <tr>
                                <td colspan="3" style="vertical-align:top; font-size:9pt;">
                                    <b>MANUFACTURER:</b> FON KOZMETIK SAN. VE TİC. LTD. STI.<br>
                                    ${d.gtip ? `<b>G.T.I.P:</b> ${d.gtip}<br>` : ''}
                                    GOODS ARE OF TURKISH ORIGIN.
                                </td>
                                <td colspan="3" class="border" style="vertical-align:top; font-size:9pt;">
                                    <b>BANK: VAKIFBANK (${d.cur})</b><br>
                                    BENEFICIARY: FON KOZMETİK SAN.VE TİC.LTD.ŞTİ.<br>
                                    IBAN: TR81 0001 5001 5804 8020 9710 65<br>
                                    SWIFT: TVBATR2A
                                </td>
                            </tr>

                            <tr><td colspan="6" style="height:20px;"></td></tr>

                            <!-- SIGNATURE -->
                            <tr>
                                <td colspan="3"></td>
                                <td colspan="3" style="text-align:center; font-weight:bold;">
                                    FON KOZMETIK SAN. VE TİC. LTD. STI.
                                </td>
                            </tr>
                        </table>
                    </body>
                    </html>
                `;

                const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Fatura_${d.no}.xls`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error("Excel Export Error:", error);
                alert("Excel oluşturulurken hata: " + error.message);
            }
        }
        function resetForm() {
            currentId = null;
            document.getElementById('btn-del').style.display = 'none';
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
            document.getElementById('i-owner').value = auth.currentUser.email;
            items = []; renderPages();
            document.getElementById('i-date').valueAsDate = new Date();
        }

        function saveInvoice() {
            let ownerEmail = auth.currentUser.email;

            if (auth.currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase()) {
                const adminInput = document.getElementById('i-owner').value;
                if (adminInput && adminInput.trim() !== "") {
                    ownerEmail = adminInput.trim();
                }
            }

            const data = {
                type: document.getElementById('i-type').value,
                currency: document.getElementById('i-currency').value,
                importer: document.getElementById('i-imp').value,
                address: document.getElementById('i-addr').value,
                tel: document.getElementById('i-tel').value,
                no: document.getElementById('i-no').value,
                date: document.getElementById('i-date').value,
                contr: document.getElementById('i-contr').value,
                loading: document.getElementById('i-load').value,
                transport: document.getElementById('i-trans').value,
                payment: document.getElementById('i-pay').value,
                delivery: document.getElementById('i-del').value,
                boxes: document.getElementById('i-box').value,
                nw: document.getElementById('i-nw').value,
                gw: document.getElementById('i-gw').value,
                gtip: document.getElementById('i-gtip').value,
                items: items,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: ownerEmail
            };
            if (currentId) {
                db.collection('invoices').doc(currentId).set(data, { merge: true }).then(() => alert("Güncellendi!")).catch(e => alert(e.message));
            } else {
                db.collection('invoices').add(data).then(() => { alert("Kaydedildi!"); resetForm(); getInvoices(); }).catch(e => alert(e.message));
            }
        }

        function getInvoices() {
            const listDiv = document.getElementById('invoice-list-area');
            listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Faturalar Yükleniyor...</div>';

            let query = db.collection('invoices');

            if (auth.currentUser.email.toLowerCase() !== SUPER_ADMIN_EMAIL.toLowerCase()) {
                query = query.where('createdBy', '==', auth.currentUser.email);
            }

            query = query.orderBy('createdAt', 'desc');

            query.get().then(snap => {
                listDiv.innerHTML = '';

                customerDB = {}; productDB = {}; userSet = new Set();

                if (snap.empty) {
                    listDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">Görüntülenecek fatura bulunamadı.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();

                    if (d.importer && !customerDB[d.importer]) customerDB[d.importer] = { addr: d.address, tel: d.tel };
                    if (d.items) d.items.forEach(it => { if (!productDB[it.name]) productDB[it.name] = { code: it.code, price: it.price }; });
                    if (d.createdBy) userSet.add(d.createdBy);

                    const el = document.createElement('div');
                    el.className = 'invoice-item';

                    el.innerHTML = `
                        <div class="inv-top">
                            <div style="display:flex; align-items:center; overflow:hidden; flex:1;">
                                <span class="inv-badge">${d.currency}</span>
                                <span class="inv-cust">${d.importer}</span>
                            </div>
                            <span class="inv-no">${d.no}</span>
                        </div>
                        
                        <div class="inv-btm">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <i class="far fa-calendar-alt"></i> ${formatDateDDMMYYYY(d.date)}
                            </div>
                            <div style="font-style:italic; color:#3699ff;">
                                <i class="fas fa-user-circle" style="margin-right:3px;"></i>${d.createdBy}
                            </div>
                        </div>
                    `;
                    el.onclick = () => loadInvoice(doc.id, d);
                    listDiv.appendChild(el);
                });
                updateDatalists();
            })
                .catch(error => {
                    console.error("Hata:", error);
                    listDiv.innerHTML = `
                    <div style="color:#f64e60; background:#ffe2e5; padding:15px; border-radius:8px; font-size:12px; margin-top:10px;">
                        <strong>Veriler Çekilemedi!</strong><br>
                        ${error.message}<br><br>
                        ${error.message.includes('index')
                            ? '<strong>ÇÖZÜM:</strong> Veritabanı "Index" hatası. Lütfen konsolu (F12) açıp linke tıklayın.'
                            : 'İnternet bağlantınızı kontrol edin.'}
                    </div>
                `;
                });
        }

        function loadInvoice(id, d) {
            currentId = id;
            document.getElementById('btn-del').style.display = 'block';

            if (document.getElementById('i-owner')) {
                document.getElementById('i-owner').value = d.createdBy || '';
            }

            document.getElementById('i-type').value = d.type;
            document.getElementById('i-currency').value = d.currency;
            document.getElementById('i-imp').value = d.importer;
            document.getElementById('i-addr').value = d.address;
            document.getElementById('i-tel').value = d.tel;
            document.getElementById('i-no').value = d.no;
            document.getElementById('i-date').value = d.date;
            document.getElementById('i-contr').value = d.contr || '';
            document.getElementById('i-load').value = d.loading;
            document.getElementById('i-trans').value = d.transport;
            document.getElementById('i-pay').value = d.payment;
            document.getElementById('i-del').value = d.delivery;
            document.getElementById('i-box').value = d.boxes;
            document.getElementById('i-nw').value = d.nw;
            document.getElementById('i-gw').value = d.gw;
            document.getElementById('i-gtip').value = d.gtip || '';
            items = d.items || [];
            renderPages(); switchView('editor');

            if (window.innerWidth <= 900) {
                document.getElementById('sidebar').classList.remove('active');
                document.querySelector('.overlay').classList.remove('active');
            }
        }

        function deleteInvoice() {
            if (confirm("Silinecek?")) {
                db.collection('invoices').doc(currentId).delete().then(() => { alert("Silindi"); resetForm(); getInvoices(); });
            }
        }

        function formatDateDDMMYYYY(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function numberToEnglishWords(n) {
            if (n < 0) return false;
            let single = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            let double = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            let tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            let format = (num) => {
                if (num === 0) return '';
                else if (num < 10) return single[num] + ' ';
                else if (num < 20) return double[num - 10] + ' ';
                else if (num < 100) return tens[Math.floor(num / 10)] + ' ' + format(num % 10);
                else if (num < 1000) return single[Math.floor(num / 100)] + ' Hundred ' + format(num % 100);
                else if (num < 1000000) return format(Math.floor(num / 1000)) + ' Thousand ' + format(num % 1000);
                else if (num < 1000000000) return format(Math.floor(num / 1000000)) + ' Million ' + format(num % 1000000);
                else return '';
            };
            return format(n).trim();
        }

        window.onload = () => {
            document.getElementById('i-date').valueAsDate = new Date();
            renderPages();
            convertImagesToBase64();
        }
    </script>
</body>

</html>